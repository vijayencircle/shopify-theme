{% assign product_count = section.blocks.size %}
{% assign enable_slider = false %}
{% if product_count > 4 %}
  {% assign enable_slider = true %}
{% endif %}

<section
  id="popular-products-{{ section.id }}"
  class="pp-section {% if enable_slider %}pp-has-slider{% endif %}"
  style="
    --heading-color: {{ section.settings.heading_color }};
    --price-color: {{ section.settings.price_color }};
    --btn-bg: {{ section.settings.button_bg }};
    --btn-text: {{ section.settings.button_text_color }};
  "
>
  <div class="page-width">

    {% if section.settings.heading != blank %}
      <h2 class="pp-heading">{{ section.settings.heading }}</h2>
    {% endif %}

    <div class="pp-slider-wrap">

      {% if enable_slider %}
        <button
          class="pp-arrow left"
          onclick="ppSlide('{{ section.id }}', -1)"
          aria-label="Previous"
        >
          <svg viewBox="0 0 24 24" width="18" height="18">
            <path d="M15 18l-6-6 6-6" fill="none" stroke="currentColor" stroke-width="2"/>
          </svg>
        </button>
      {% endif %}

      <div class="pp-grid" id="pp-grid-{{ section.id }}">
        {% for block in section.blocks %}
          {% assign product = block.settings.product %}
          {% if product != blank %}
            <div class="pp-card">

              <div class="pp-image">
                {% if block.settings.badge_text != blank %}
                  <span class="pp-badge">{{ block.settings.badge_text }}</span>
                {% endif %}
                <img
                  src="{{ product.featured_image | image_url: width: 500 }}"
                  alt="{{ product.title }}"
                  loading="lazy"
                >
              </div>

              <div class="pp-info">
                <span class="pp-price">{{ product.price | money }}</span>

                <h3 class="pp-title">
                  <a href="{{ product.url }}">{{ product.title }}</a>
                </h3>

                {% if block.settings.show_description %}
                  <p class="pp-desc">
                    {{ product.description | strip_html | truncate: 90 }}
                  </p>
                {% endif %}
              </div>

            </div>
          {% endif %}
        {% endfor %}
      </div>

      {% if enable_slider %}
        <button
          class="pp-arrow right"
          onclick="ppSlide('{{ section.id }}', 1)"
          aria-label="Next"
        >
          <svg viewBox="0 0 24 24" width="18" height="18">
            <path d="M9 6l6 6-6 6" fill="none" stroke="currentColor" stroke-width="2"/>
          </svg>
        </button>
      {% endif %}

    </div>

    {% if section.settings.button_text != blank %}
      <div class="pp-footer">
        <a href="{{ section.settings.button_link }}" class="pp-btn">
          {{ section.settings.button_text }} â†’
        </a>
      </div>
    {% endif %}

  </div>
</section>

<style>
/* ===============================
   SECTION
   =============================== */
.pp-section {
  padding: 70px 0;
  overflow-x: hidden; /* MOBILE SAFETY */
}

.pp-heading {
  text-align: center;
  font-size: 32px;
  font-weight: 900;
  color: var(--heading-color);
  margin-bottom: 40px;
}

/* ===============================
   GRID
   =============================== */
.pp-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 28px;
}

/* SLIDER MODE */
.pp-has-slider .pp-grid {
  display: flex;
  overflow-x: hidden;
  scroll-behavior: smooth;
}

/* CARD */
.pp-card {
  width: 100%;
  flex: 0 0 25%;
}

/* IMAGE */
.pp-image {
  position: relative;
  border-radius: 14px;
  overflow: hidden;
}

.pp-image img {
  width: 100%;
  height: 260px;
  object-fit: cover;
}

/* BADGE */
.pp-badge {
  position: absolute;
  top: 10px;
  left: 10px;
  background: #ff3b2f;
  color: #fff;
  font-size: 12px;
  padding: 6px 10px;
  border-radius: 999px;
  font-weight: 700;
}

/* INFO */
.pp-info {
  padding-top: 14px;
}

.pp-price {
  color: var(--price-color);
  font-weight: 700;
}

.pp-title {
  font-size: 16px;
  font-weight: 700;
}

.pp-title a {
  color: #000;
  text-decoration: none;
}

.pp-desc {
  font-size: 13px;
  color: #777;
}

/* ===============================
   ARROWS
   =============================== */
.pp-slider-wrap {
  position: relative;
}

.pp-arrow {
  position: absolute;
  top: 34%;
  transform: translateY(-50%);
  width: 52px;
  height: 52px;
  border-radius: 50px;
  border: none;
  background: #ff3b2f;
  color: #fff;
  cursor: pointer;
  z-index: 5;
}

.pp-arrow.left { left: -26px;text-align: center; }
.pp-arrow.right { right: -26px;text-align: center; }

/* ===============================
   BUTTON
   =============================== */
.pp-footer {
  text-align: center;
  margin-top: 40px;
}

.pp-btn {
  background: var(--btn-bg);
  color: var(--btn-text);
  padding: 12px 26px;
  border-radius: 10px;
  font-weight: 700;
  text-decoration: none;
}

/* ===============================
   TABLET
   =============================== */
@media (max-width: 1024px) {
  .pp-grid {
    grid-template-columns: repeat(2, 1fr);
  }

  .pp-has-slider .pp-card {
    flex: 0 0 50%;
  }
}

/* ===============================
   MOBILE FIX (NO UI CHANGE)
   =============================== */
@media (max-width: 640px) {

  .pp-slider-wrap {
    padding: 0 40px; /* keeps arrows inside */
  }

  .pp-grid {
    grid-template-columns: 1fr;
  }

  .pp-has-slider .pp-card {
    flex: 0 0 100%;
  }

  .pp-arrow {
    width: 42px;
    height: 42px;
    top: 40%;
  }

  .pp-arrow.left { left: 14px;top: 110px; }
  .pp-arrow.right { right: 14px; top: 110px; }

  .pp-image img {
    height: 220px;
  }
}

</style>

{% if enable_slider %}
<script>
function ppSlide(id, dir) {
  const grid = document.getElementById('pp-grid-' + id);
  const card = grid.querySelector('.pp-card');
  if (!card) return;

  const gap = 28;
  const slideAmount = card.offsetWidth + gap;

  grid.scrollBy({
    left: dir * slideAmount,
    behavior: 'smooth'
  });
}
</script>
{% endif %}

{% schema %}
{
  "name": "Popular Products",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Section heading",
      "default": "Popular Products"
    },
    {
      "type": "color",
      "id": "heading_color",
      "label": "Heading color",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "price_color",
      "label": "Price color",
      "default": "#ff3b2f"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Bottom button text",
      "default": "Buy Now"
    },
    {
      "type": "url",
      "id": "button_link",
      "label": "Bottom button link"
    },
    {
      "type": "color",
      "id": "button_bg",
      "label": "Button background",
      "default": "#ff3b2f"
    },
    {
      "type": "color",
      "id": "button_text_color",
      "label": "Button text color",
      "default": "#ffffff"
    }
  ],
  "blocks": [
    {
      "type": "product",
      "name": "Product",
      "settings": [
        {
          "type": "product",
          "id": "product",
          "label": "Select product"
        },
        {
          "type": "text",
          "id": "badge_text",
          "label": "Badge text",
          "default": "10% OFF"
        },
        {
          "type": "checkbox",
          "id": "show_description",
          "label": "Show description",
          "default": true
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Popular Products",
      "blocks": [
        { "type": "product" },
        { "type": "product" },
        { "type": "product" },
        { "type": "product" }
      ]
    }
  ]
}
{% endschema %}
